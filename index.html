<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Barra Controlada por Joystick</title>
<style>
  :root{
    --card-bg: rgba(255,255,255,0.14);
    --card-stroke: rgba(255,255,255,0.35);
    --shadow: 0 20px 60px rgba(0,0,0,0.25);
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100svh; display:grid; place-items:center;
    background: radial-gradient(1200px 800px at 10% 10%, #2dd4bf 0%, rgba(45,212,191,0) 60%),
                radial-gradient(1200px 900px at 90% 90%, #60a5fa 0%, rgba(96,165,250,0) 60%),
                linear-gradient(160deg, #0f172a 0%, #111827 100%);
    color:#e5e7eb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
  }
  .wrap{
    width:min(100%,1100px); padding:24px;
    display:grid; gap:24px;
    grid-template-columns: 1.1fr 1fr;
  }
  @media (max-width:840px){ .wrap{grid-template-columns: 1fr} }

  .card{
    backdrop-filter: blur(14px) saturate(1.2);
    background: var(--card-bg);
    border: 1px solid var(--card-stroke);
    border-radius: 20px; padding: 20px; box-shadow: var(--shadow);
  }

  /* Painel da Barra */
  .bar-panel{ display:grid; grid-template-columns: 1fr auto; gap:20px; align-items:stretch; }
  .bar-frame{
    position:relative; border-radius:16px; border:1px dashed rgba(255,255,255,0.35);
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    padding:16px; display:flex; align-items:center; justify-content:center;
  }
  .bar-track{
    width:min(140px, 40vw); max-width:200px; height:60vh; max-height:560px;
    border-radius:16px; background:linear-gradient(180deg,#0b1020,#0b1226);
    border:1px solid rgba(255,255,255,0.15); position:relative; overflow:hidden;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), inset 0 20px 40px rgba(255,255,255,0.06);
  }
  .bar-fill{
    position:absolute; left:0; bottom:0; width:100%; height:50%;
    background: linear-gradient(180deg,#93c5fd,#38bdf8 40%, #22d3ee 100%);
    box-shadow: inset 0 8px 20px rgba(255,255,255,0.45);
    transition: height 160ms ease-out;
    will-change: height;
  }
  .bar-glow{
    position:absolute; inset: -20% -20% auto -20%; height:40%;
    background: radial-gradient(closest-side, rgba(56,189,248,0.45), rgba(56,189,248,0));
    filter: blur(20px); pointer-events:none;
  }
  .bar-scale{ position:absolute; inset:8px; display:flex; flex-direction:column; justify-content:space-between; pointer-events:none; }
  .bar-scale span{ font-size:12px; color:#cbd5e1; opacity:0.8 }

  .value-badge{
    align-self:flex-start;
    font-size:48px; font-weight:700; letter-spacing:-0.02em; line-height:1;
    display:flex; gap:10px; align-items:baseline;
  }
  .unit{ font-size:14px; opacity:0.8 }
  .hint{ font-size:12px; opacity:0.75 }

  /* Painel de Controles */
  .controls{ display:grid; gap:16px }
  .row{ display:flex; gap:14px; align-items:center; flex-wrap:wrap }
  .chip{
    padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,0.25);
    background: rgba(255,255,255,0.06); font-size:12px
  }
  .kbd{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    padding:4px 8px; border-radius:8px; border:1px solid rgba(255,255,255,0.25);
    background: rgba(255,255,255,0.08); font-size:12px
  }
  .slider{ width:200px; max-width:60vw }
  .btn{
    appearance:none; border:0; cursor:pointer; padding:12px 16px; border-radius:12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.09));
    border:1px solid rgba(255,255,255,0.35); color:#fff; font-weight:600; box-shadow: var(--shadow);
    transition: transform .12s ease, background .2s ease;
  }
  .btn:active{ transform: translateY(1px) scale(.99) }
  .btn-alt{ background: linear-gradient(180deg, rgba(125,211,252,0.25), rgba(125,211,252,0.10)) }

  /* Pequeno monitor do gamepad */
  .gp-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:12px }
  .meter{
    height:8px; background:rgba(255,255,255,0.12); border-radius:999px; overflow:hidden
  }
  .meter > div{ height:100%; width:50%; transition: width 80ms linear;
    background: linear-gradient(90deg, #34d399, #60a5fa) }

  footer{ text-align:center; opacity:0.75; font-size:12px }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Painel da Barra -->
    <section class="card bar-panel">
      <div class="bar-frame">
        <div class="bar-track" aria-label="Indicador de nível">
          <div class="bar-fill" id="barFill"></div>
          <div class="bar-glow"></div>
          <div class="bar-scale" aria-hidden="true">
            <span>100%</span><span>80%</span><span>60%</span><span>40%</span><span>20%</span><span>0%</span>
          </div>
        </div>
      </div>
      <div style="display:flex; flex-direction:column; gap:14px; justify-content:center">
        <div class="value-badge">
          <span id="valueText">50</span><span class="unit">%</span>
        </div>
        <div class="hint">Use o analógico <strong>esquerdo (eixo Y)</strong> ↑/↓ para ajustar. Suavização automática.</div>
        <div class="row">
          <button class="btn" id="btnUp" aria-label="Subir">↑ Subir</button>
          <button class="btn" id="btnDown" aria-label="Descer">↓ Descer</button>
          <button class="btn btn-alt" id="btnCenter" aria-label="Centralizar">• Centralizar (50%)</button>
        </div>
      </div>
    </section>

    <!-- Painel de Controles / Status -->
    <aside class="card controls">
      <div class="row" style="justify-content:space-between">
        <div class="chip" id="status">Aguardando gamepad… pressione qualquer botão.</div>
        <div class="chip">Compatível: Chrome/Android</div>
      </div>

      <div class="row">
        <label for="sens">Sensibilidade</label>
        <input id="sens" class="slider" type="range" min="0.2" max="3" step="0.1" value="1.2" />
        <span class="kbd" id="sensVal">1.2×</span>
      </div>

      <div class="row">
        <label for="smooth">Suavização</label>
        <input id="smooth" class="slider" type="range" min="0.85" max="0.995" step="0.005" value="0.96" />
        <span class="kbd" id="smoothVal">0.96</span>
      </div>

      <div class="row">
        <div class="kbd">Analógico Y (filtrado): <span id="axisYDisp">0.00</span></div>
        <div class="kbd">Botões ↑/↓: <span id="btnsDisp">0 / 0</span></div>
      </div>

      <div class="gp-grid">
        <div>Entrada ↑/↓</div><div class="meter"><div id="meter"></div></div>
        <div>Gamepad</div><div id="gpName">—</div>
      </div>

      <footer>
        Dica: Alguns controles só aparecem após “acordar” o gamepad com um clique de botão.<br/>
        Se seu controle não for detectado, ative Bluetooth/OTG e teste em <code>chrome://gamepad-internals</code>.
      </footer>
    </aside>
  </div>

<script>
(() => {
  // Estado principal
  let level = 50;           // 0..100 (nível "real")
  let displayLevel = 50;    // nível exibido (ease)
  let axisYFiltered = 0;    // eixo Y com filtro
  let lastTs = performance.now();
  let connectedIndex = null;

  // Configs ajustáveis
  let sensitivity = 1.2;    // ganho base
  let smoothing = 0.96;     // filtro exponencial para entrada e exibição

  // UI refs
  const barFill   = document.getElementById('barFill');
  const valueText = document.getElementById('valueText');
  const statusEl  = document.getElementById('status');
  const sensEl    = document.getElementById('sens');
  const sensVal   = document.getElementById('sensVal');
  const smoothEl  = document.getElementById('smooth');
  const smoothVal = document.getElementById('smoothVal');
  const axisYDisp = document.getElementById('axisYDisp');
  const btnsDisp  = document.getElementById('btnsDisp');
  const gpName    = document.getElementById('gpName');
  const meterBar  = document.getElementById('meter');
  const btnUp     = document.getElementById('btnUp');
  const btnDown   = document.getElementById('btnDown');
  const btnCenter = document.getElementById('btnCenter');

  // Suporte
  const supported = !!navigator.getGamepads;
  if(!supported){
    statusEl.textContent = 'Gamepad API não suportada neste navegador.';
  }

  // Conexão/desconexão
  window.addEventListener('gamepadconnected', (e) => {
    connectedIndex = e.gamepad.index;
    gpName.textContent = e.gamepad.id;
    statusEl.textContent = 'Gamepad conectado ✅';
  });

  window.addEventListener('gamepaddisconnected', () => {
    connectedIndex = null;
    gpName.textContent = '—';
    statusEl.textContent = 'Gamepad desconectado. Reconnecte e pressione um botão.';
  });

  // Interações de toque como alternativa
  let touchInterval = null;
  const startTouchMove = (dir) => {
    stopTouchMove();
    touchInterval = setInterval(() => {
      // dir: +1 para subir, -1 para descer
      level = clamp(level + dir * 0.8 * sensitivity, 0, 100);
    }, 16);
  };
  const stopTouchMove = () => { if(touchInterval){ clearInterval(touchInterval); touchInterval = null; } };

  btnUp.addEventListener('touchstart',   () => startTouchMove(+1), {passive:true});
  btnUp.addEventListener('touchend',     stopTouchMove);
  btnDown.addEventListener('touchstart', () => startTouchMove(-1), {passive:true});
  btnDown.addEventListener('touchend',   stopTouchMove);

  // Click/tap normal
  btnUp.addEventListener('mousedown',   () => startTouchMove(+1));
  btnDown.addEventListener('mousedown', () => startTouchMove(-1));
  ['mouseup','mouseleave','blur'].forEach(ev => {
    btnUp.addEventListener(ev, stopTouchMove);
    btnDown.addEventListener(ev, stopTouchMove);
  });
  btnCenter.addEventListener('click', () => { level = 50; });

  // Sliders
  sensEl.addEventListener('input', (e) => {
    sensitivity = parseFloat(e.target.value);
    sensVal.textContent = sensitivity.toFixed(1) + '×';
  });
  smoothEl.addEventListener('input', (e) => {
    smoothing = parseFloat(e.target.value);
    smoothVal.textContent = smoothing.toFixed(3);
  });

  // Loop principal
  function tick(ts){
    const dt = Math.max(0, Math.min(1/20, (ts - lastTs)/1000)); // limita dt a 50ms
    lastTs = ts;

    // Leitura do gamepad
    const gp = getActiveGamepad();
    let axisY = 0, dpadUp = 0, dpadDown = 0;

    if(gp){
      if(connectedIndex === null){ connectedIndex = gp.index; }
      // Eixo Y do analógico esquerdo é geralmente axes[1]:
      axisY = gp.axes && gp.axes.length > 1 ? gp.axes[1] : 0;
      // Botões D-pad ↑ (12) e ↓ (13) na maioria dos mapeamentos
      dpadUp = getButtonValue(gp, 12);
      dpadDown = getButtonValue(gp, 13);
      gpName.textContent = gp.id;
      statusEl.textContent = 'Gamepad conectado ✅';
    }

    // Deadzone + filtro exponencial
    const deadzone = 0.12;
    const rawY = Math.abs(axisY) < deadzone ? 0 : axisY;
    axisYFiltered = expSmooth(axisYFiltered, rawY, smoothing);

    // Controle: no eixo Y dos gamepads, -1 = para cima, +1 = para baixo
    // Movemos a barra em porcentagem/segundo; ganho proporcional à sensibilidade
    const speed = 60 * sensitivity; // % por segundo com entrada máxima
    const dFromAxis = -axisYFiltered * speed * dt;

    // D-pad como incremento sob demanda (bem suave)
    const dpadDelta = (dpadUp ? +1 : 0) + (dpadDown ? -1 : 0);
    const dFromDpad = dpadDelta * 30 * dt; // 30%/s

    level = clamp(level + dFromAxis + dFromDpad, 0, 100);

    // Exibição suavizada (ease-out exponencial)
    displayLevel = expSmooth(displayLevel, level, 0.90);

    // UI
    barFill.style.height = displayLevel.toFixed(2) + '%';
    valueText.textContent = Math.round(displayLevel);
    axisYDisp.textContent = axisYFiltered.toFixed(2);
    btnsDisp.textContent = (dpadUp?1:0) + ' / ' + (dpadDown?1:0);
    meterBar.style.width = ( (Math.max(-1, Math.min(1, -axisYFiltered)) + 1) * 50 ).toFixed(1) + '%';

    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

  // Utilitários
  function getActiveGamepad(){
    const pads = navigator.getGamepads ? navigator.getGamepads() : [];
    if(!pads) return null;
    // Se já temos um índice conectado, priorize
    if(connectedIndex !== null && pads[connectedIndex] && pads[connectedIndex].connected) return pads[connectedIndex];
    // Caso contrário, pegue o primeiro conectado
    for(const p of pads){ if(p && p.connected) return p; }
    return null;
  }
  function getButtonValue(gp, idx){
    if(!gp || !gp.buttons || !gp.buttons[idx]) return 0;
    const b = gp.buttons[idx];
    return b.value !== undefined ? b.value : (b.pressed ? 1 : 0);
  }
  function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }
  // Suavização exponencial: out = alpha*new + (1-alpha)*old
  function expSmooth(oldVal, newVal, alpha){
    // Se alpha ~ 1, resposta rápida; se ~0.9, bem suave.
    return oldVal + (newVal - oldVal) * alpha;
  }
})();
</script>
</body>
</html>
