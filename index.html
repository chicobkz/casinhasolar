<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Placa Solar x Joystick (USB)</title>
<style>
  :root{
    --bg1:#FFD54F; /* amarelo */
    --bg2:#FB8C00; /* laranja */
    --card:rgba(255,255,255,0.16);
    --card-strong:rgba(255,255,255,0.22);
    --border:rgba(255,255,255,0.35);
    --text:#04210a;
    --accent1:#14b8a6; /* verde-água */
    --accent2:#1e88e5; /* azul */
    --good:#22c55e;    /* verde */
    --blue:#3b82f6;    /* azul para detalhes */
  }
  *{box-sizing:border-box}
  html,body{height:100%;}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
    color:var(--text);
    background:linear-gradient(140deg,var(--bg1),var(--bg2));
  }

  .wrap{
    min-height:100%;
    padding-block:28px; /* margem em cima e em baixo */
    padding-inline: clamp(14px,3vw,28px);
    display:flex;
    flex-direction:column;
    gap:16px;
  }

  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }
  .brand{
    display:flex; align-items:center; gap:12px;
    padding:14px 18px;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:18px;
    backdrop-filter: blur(12px);
    box-shadow:0 10px 30px rgba(0,0,0,.12), inset 0 1px 0 rgba(255,255,255,.35);
  }
  .brand h1{
    margin:0; font-size: clamp(18px,2.4vw,24px); font-weight:700; letter-spacing:.2px;
  }
  .controls{
    display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    background:var(--card);
    border:1px solid var(--border);
    padding:10px 12px; border-radius:16px; backdrop-filter:blur(10px);
  }
  .btn{
    cursor:pointer;
    border:none;
    padding:12px 18px;
    font-weight:700;
    border-radius:14px;
    color:white;
    background:linear-gradient(90deg,var(--accent1),var(--accent2));
    box-shadow:0 8px 22px rgba(15,76,129,.25);
    transition:transform .06s ease;
  }
  .btn:active{ transform:scale(.98); }
  .hint{font-size:12px; opacity:.9}

  /* LAYOUT: 2 colunas (info à esquerda, gráfico à direita) */
  main{
    display:grid;
    grid-template-columns: minmax(280px, 420px) 1fr;
    gap:16px;
  }
  @media (max-width:900px){
    main{ grid-template-columns: 1fr; }
  }

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:22px;
    backdrop-filter: blur(14px);
    padding:18px;
    box-shadow:0 14px 40px rgba(0,0,0,.15), inset 0 1px 0 rgba(255,255,255,.35);
  }

  /* Painel de informações (esquerda) */
  .info h2{margin:0 0 10px 0; font-size: clamp(18px,2.2vw,22px)}
  .metrics{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    margin-bottom:12px;
  }
  .kpi{
    padding:12px;
    border-radius:16px;
    background:var(--card-strong);
    border:1px solid var(--border);
  }
  .kpi .label{opacity:.9; font-size:12px}
  .kpi .value{ font-size: clamp(18px,2.6vw,26px); font-weight:800}
  .loads{
    margin-top:10px; font-size:14px; line-height:1.35;
    padding:12px; border-radius:14px;
    background:rgba(255,255,255,.14);
    border:1px dashed var(--border);
  }

  /* Gráfico (direita) */
  .chartArea{
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .barwrap{
    position:relative;
    width:min(320px,70vw);          /* barra bem larga */
    height:min(520px,75vh);         /* barra alta */
    border-radius:28px;
    background:linear-gradient(180deg, rgba(255,255,255,.25), rgba(255,255,255,.10));
    border:1px solid var(--border);
    box-shadow: inset 0 -10px 20px rgba(0,0,0,.08), inset 0 1px 0 rgba(255,255,255,.45);
    overflow:hidden;
  }
  .ticks{ position:absolute; inset:10px; pointer-events:none; }
  .tick{ position:absolute; left:8px; right:8px; border-top:1px dashed rgba(255,255,255,.55); }
  .tick .tlabel{
    position:absolute; right:-4px; transform:translateY(-50%);
    background:rgba(255,255,255,.7); color:#093; font-weight:800;
    font-size:12px; padding:2px 6px; border-radius:10px; border:1px solid rgba(0,0,0,.06);
  }
  .bar{
    position:absolute; bottom:0; left:0; right:0;
    height:0%;
    background: linear-gradient(180deg, var(--good), var(--blue));
    box-shadow: inset 0 10px 24px rgba(255,255,255,.25), 0 -6px 18px rgba(0,0,0,.12);
    transition: height .6s cubic-bezier(.22,1,.36,1);
  }
  .percentTag{
    position:absolute;
    top:10px; left:50%; transform:translateX(-50%);
    background:rgba(255,255,255,.8); padding:8px 12px; border-radius:999px;
    border:1px solid rgba(0,0,0,.06);
    font-weight:900; letter-spacing:.2px;
  }

  footer{
    opacity:.9; font-size:12px; text-align:center; margin-top:6px;
  }

  /* Modal de configuração */
  .modal{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.35);
  }
  .modal .sheet{
    width:min(520px,90vw);
    background:var(--card);
    border:1px solid var(--border);
    border-radius:20px;
    padding:18px;
    backdrop-filter:blur(14px);
    box-shadow:0 20px 60px rgba(0,0,0,.25);
  }
  .modal .sheet h3{margin:0 0 6px 0}
  .modal .sheet p{margin:8px 0}
  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-top:10px}
  .chip{
    padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.6);
    font-weight:700; font-size:13px;
  }
  .small{font-size:12px; opacity:.85}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 3l3 5h-6l3-5zm-6.5 9a6.5 6.5 0 1013 0h-2a4.5 4.5 0 11-9 0h-2z" fill="#0ea5a8"/>
          <circle cx="12" cy="17.5" r="3.5" fill="#1e88e5"/>
        </svg>
        <h1>Placa Solar (1 W) x Placa 1000 W • Controle USB</h1>
      </div>
      <div class="controls">
        <button class="btn" id="startBtn">Iniciar leitura</button>
        <button class="btn" id="cfgBtn" title="Ajuste caso os botões não sejam reconhecidos">Configurar botões</button>
        <span id="gpStatus" class="hint">Conecte o controle por USB, clique em “Iniciar leitura” e pressione qualquer botão.</span>
      </div>
    </header>

    <main>
      <!-- ESQUERDA: Informações em tempo real -->
      <section class="card info" aria-live="polite">
        <h2>Informações (tempo real)</h2>
        <div class="metrics">
          <div class="kpi">
            <div class="label">Nível do gráfico</div>
            <div class="value"><span id="kpiPerc">0</span>%</div>
          </div>
          <div class="kpi">
            <div class="label">Mini placa (1 W máx)</div>
            <div class="value"><span id="kpiMini">0,00</span> W</div>
          </div>
          <div class="kpi">
            <div class="label">Placa residencial (1000 W)</div>
            <div class="value"><span id="kpiHouse">0</span> W</div>
          </div>
          <div class="kpi">
            <div class="label">Situação</div>
            <div class="value" id="kpiLabel">Sem energia</div>
          </div>
        </div>
        <div class="loads">
          <strong>O que daria para ligar em casa:</strong>
          <div id="loadsText">Nada — sem energia disponível.</div>
          <div class="small" style="margin-top:6px">
            <em>Observação:</em> estimativas aproximadas; não considera picos de partida (ex.: geladeira).
          </div>
        </div>
      </section>

      <!-- DIREITA: Gráfico -->
      <section class="card chartArea">
        <div class="barwrap" role="img" aria-label="Barra vertical de produção de energia">
          <div class="percentTag"><span id="percentTop">0</span>%</div>
          <div class="ticks">
            <!-- 35% -->
            <div class="tick" style="top: calc(100% - 35% - 10px);">
              <span class="tlabel" style="top:0">35%</span>
            </div>
            <!-- 70% -->
            <div class="tick" style="top: calc(100% - 70% - 10px);">
              <span class="tlabel" style="top:0">70%</span>
            </div>
            <!-- 100% -->
            <div class="tick" style="top: calc(0% + 0px);">
              <span class="tlabel" style="top:0">100%</span>
            </div>
          </div>
          <div id="bar" class="bar"></div>
        </div>
      </section>
    </main>

    <footer>
      Gamepad API (Android/Windows). Layout responsivo com margens superior e inferior. Use “Configurar botões” se seu controle tiver mapeamento diferente.
    </footer>
  </div>

  <!-- Modal de configuração -->
  <div id="cfgModal" class="modal" aria-hidden="true">
    <div class="sheet">
      <h3>Configuração rápida dos botões</h3>
      <p>Alguns controles têm mapeamentos diferentes. Vamos ensinar à página quais botões serão usados.</p>
      <ol class="small">
        <li>Clique em <strong>Começar</strong> abaixo;</li>
        <li>Quando solicitado, <strong>pressione e solte</strong> o botão desejado para cada função (B11, B10, B9);</li>
        <li>Ao terminar, feche esta janela.</li>
      </ol>
      <div class="row">
        <button class="btn" id="cfgStart">Começar</button>
        <button class="btn" id="cfgClose" style="background:linear-gradient(90deg,#6b7280,#374151)">Fechar</button>
        <span id="cfgStep" class="chip">Pronto para iniciar</span>
      </div>
      <div class="small" style="margin-top:10px">
        Dica: se algum botão não registrar, tente novamente. Também aceitamos eixos analógicos (por exemplo, gatilhos); mova-os com força para registrar.
      </div>
    </div>
  </div>

<script>
(() => {
  // ======== UI refs ========
  const bar = document.getElementById('bar');
  const percentTop = document.getElementById('percentTop');
  const kpiPerc = document.getElementById('kpiPerc');
  const kpiMini = document.getElementById('kpiMini');
  const kpiHouse = document.getElementById('kpiHouse');
  const loadsText = document.getElementById('loadsText');
  const kpiLabel = document.getElementById('kpiLabel');
  const startBtn = document.getElementById('startBtn');
  const cfgBtn = document.getElementById('cfgBtn');
  const gpStatus = document.getElementById('gpStatus');

  // Modal
  const cfgModal = document.getElementById('cfgModal');
  const cfgStart = document.getElementById('cfgStart');
  const cfgClose = document.getElementById('cfgClose');
  const cfgStep = document.getElementById('cfgStep');

  // ======== State ========
  let rafId = null;
  let running = false;

  // Mapping: aceita botões OU eixos (com sinal)
  const map = {
    b9:  { kind:'button', index:9,  sign: 1, thresh:0.5 },
    b10: { kind:'button', index:10, sign: 1, thresh:0.5 },
    b11: { kind:'button', index:11, sign: 1, thresh:0.5 },
  };

  // Config flow
  let captureTarget = null; // 'b11','b10','b9' na ordem
  let captureOrder = ['b11','b10','b9'];
  let captureIdx = 0;

  function fmt(n, d=2){
    return n.toLocaleString('pt-BR', {minimumFractionDigits:d, maximumFractionDigits:d});
  }

  function describeLoads(pHouseW){
    if (pHouseW < 1) return 'Nada — sem energia disponível.';
    if (pHouseW < 400) return '1 TV LED (~100 W), roteador Wi-Fi (~10 W) e 3–5 lâmpadas LED (30–50 W) + ventilador pequeno (~50 W).';
    if (pHouseW < 850) return 'Geladeira (em funcionamento ~150 W, sem considerar pico) + TV LED + roteador + 5–8 lâmpadas + ventilador.';
    return 'Geladeira + TV + roteador + lâmpadas + notebook/PC leve. (Atenção aos picos de partida da geladeira.)';
  }

  function labelFor(perc){
    switch(perc){
      case 0: return 'Sem energia';
      case 35: return 'Baixa produção';
      case 70: return 'Média produção';
      case 100: return 'Produção máxima';
      default: return 'Produção';
    }
  }

  function updateUI(perc){
    bar.style.height = perc + '%';
    percentTop.textContent = perc;
    kpiPerc.textContent = perc;

    const pMiniW  = (perc/100) * 1;     // até 1 W
    const pHouseW = (perc/100) * 1000;  // até 1000 W

    kpiMini.textContent = fmt(pMiniW, 2);
    kpiHouse.textContent = pHouseW.toLocaleString('pt-BR', {maximumFractionDigits:0});
    loadsText.textContent = describeLoads(pHouseW);
    kpiLabel.textContent = labelFor(perc);
  }

  function setConnected(connected, id=''){
    gpStatus.textContent = connected
      ? ('Controle detectado' + (id ? ' • ' + id : ''))
      : 'Conecte o controle por USB, clique em “Iniciar leitura” e pressione qualquer botão.';
  }

  function btnPressed(btn){
    return btn && (btn.pressed || btn.value > 0.6);
  }

  function isActive(gp, conf){
    if (conf.kind === 'button'){
      const b = gp.buttons[conf.index];
      return btnPressed(b);
    } else if (conf.kind === 'axis'){
      const v = gp.axes[conf.index] || 0;
      return conf.sign > 0 ? v > conf.thresh : v < -conf.thresh;
    }
    return false;
  }

  function captureInput(gp){
    // Procura botão pressionado
    for (let i=0; i<(gp.buttons?.length||0); i++){
      if (btnPressed(gp.buttons[i])){
        map[captureTarget] = { kind:'button', index:i, sign:1, thresh:0.5 };
        return {kind:'button', index:i};
      }
    }
    // Procura eixo com desvio forte
    for (let i=0; i<(gp.axes?.length||0); i++){
      const v = gp.axes[i];
      if (v > 0.7){
        map[captureTarget] = { kind:'axis', index:i, sign:1, thresh:0.5 };
        return {kind:'axis', index:i, sign:1};
      }
      if (v < -0.7){
        map[captureTarget] = { kind:'axis', index:i, sign:-1, thresh:0.5 };
        return {kind:'axis', index:i, sign:-1};
      }
    }
    return null;
  }

  function loop(){
    const pads = navigator.getGamepads ? navigator.getGamepads() : [];
    const gp = pads && pads[0];

    if (gp){
      setConnected(true, gp.id);

      // Fluxo de captura de mapeamento (se ativo)
      if (captureTarget){
        const got = captureInput(gp);
        if (got){
          cfgStep.textContent = `Registrado ${captureTarget.toUpperCase()}: ${got.kind} #${got.index}`;
          // Avança
          captureIdx++;
          if (captureIdx < captureOrder.length){
            captureTarget = captureOrder[captureIdx];
            cfgStep.textContent += ` • Agora pressione ${captureTarget.toUpperCase()}`;
          } else {
            // Concluiu
            captureTarget = null;
            cfgStep.textContent += ' • Concluído!';
          }
        }
      }

      // Lógica dos níveis com base nos mapeamentos atuais
      let b9  = isActive(gp, map.b9);
      let b10 = isActive(gp, map.b10);
      let b11 = isActive(gp, map.b11);

      let next = 0;
      if (b11 && b10 && b9)      next = 100;
      else if (b11 && b10)       next = 70;
      else if (b11)              next = 35;
      else                       next = 0;

      updateUI(next);
    } else {
      setConnected(false);
    }

    rafId = requestAnimationFrame(loop);
  }

  // ======== Controls ========
  startBtn.addEventListener('click', () => {
    if (!running){
      running = true;
      if (rafId) cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(loop);
    }
  });

  cfgBtn.addEventListener('click', () => {
    cfgModal.style.display = 'flex';
    cfgModal.setAttribute('aria-hidden', 'false');
  });

  cfgStart.addEventListener('click', () => {
    captureIdx = 0;
    captureTarget = captureOrder[captureIdx];
    cfgStep.textContent = `Pressione ${captureTarget.toUpperCase()}…`;
  });

  cfgClose.addEventListener('click', () => {
    cfgModal.style.display = 'none';
    cfgModal.setAttribute('aria-hidden', 'true');
  });

  window.addEventListener('gamepadconnected', (e) => setConnected(true, e.gamepad.id));
  window.addEventListener('gamepaddisconnected', () => setConnected(false));

  // Teclado (fallback rápido para testes): 1=35%, 2=70%, 3=100%, 0=0%
  window.addEventListener('keydown', (e) => {
    if (e.key === '1') updateUI(35);
    else if (e.key === '2') updateUI(70);
    else if (e.key === '3') updateUI(100);
    else if (e.key === '0') updateUI(0);
  });

  // Inicial
  updateUI(0);
})();
</script>
</body>
</html>
    cursor:pointer;
    border:none;
    padding:12px 18px;
    font-weight:700;
    border-radius:14px;
    color:white;
    background:linear-gradient(90deg,var(--accent1),var(--accent2));
    box-shadow:0 8px 22px rgba(15,76,129,.25);
    transition:transform .06s ease;
  }
  .btn:active{ transform:scale(.98); }

  main{
    display:grid;
    grid-template-columns: 360px 1fr 320px;
    gap:16px;
  }
  @media (max-width:1100px){
    main{ grid-template-columns: 1fr; }
  }

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:22px;
    backdrop-filter: blur(14px);
    padding:18px;
    box-shadow:0 14px 40px rgba(0,0,0,.15), inset 0 1px 0 rgba(255,255,255,.35);
  }

  /* Painel de informações (esquerda) */
  .info h2{margin:0 0 10px 0; font-size: clamp(18px,2.2vw,22px)}
  .metrics{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    margin-bottom:12px;
  }
  .kpi{
    padding:12px;
    border-radius:16px;
    background:var(--card-strong);
    border:1px solid var(--border);
  }
  .kpi .label{opacity:.9; font-size:12px}
  .kpi .value{ font-size: clamp(18px,2.6vw,26px); font-weight:800}
  .loads{
    margin-top:10px; font-size:14px; line-height:1.35;
    padding:12px; border-radius:14px;
    background:rgba(255,255,255,.14);
    border:1px dashed var(--border);
  }

  /* Gráfico (centro) */
  .chart{
    display:grid;
    grid-template-columns: 1fr auto 1fr;
    align-items:center;
    gap:14px;
  }
  .barwrap{
    position:relative;
    margin-inline:auto;
    width:min(240px,60vw);          /* barra larga */
    height:min(460px,70vh);         /* barra alta */
    border-radius:24px;
    background:linear-gradient(180deg, rgba(255,255,255,.25), rgba(255,255,255,.10));
    border:1px solid var(--border);
    box-shadow: inset 0 -10px 20px rgba(0,0,0,.08), inset 0 1px 0 rgba(255,255,255,.45);
    overflow:hidden;
  }
  .ticks{
    position:absolute; inset:10px 10px 10px 10px; pointer-events:none;
  }
  .tick{
    position:absolute; left:8px; right:8px;
    border-top:1px dashed rgba(255,255,255,.55);
  }
  .tick .tlabel{
    position:absolute; right:-4px; transform:translateY(-50%);
    background:rgba(255,255,255,.7); color:#093; font-weight:800;
    font-size:12px; padding:2px 6px; border-radius:10px; border:1px solid rgba(0,0,0,.06);
  }

  .bar{
    position:absolute; bottom:0; left:0; right:0;
    height:0%;
    background: linear-gradient(180deg, var(--good), var(--blue));
    box-shadow: inset 0 10px 24px rgba(255,255,255,.25), 0 -6px 18px rgba(0,0,0,.12);
    transition: height .6s cubic-bezier(.22,1,.36,1);
  }
  .percentTag{
    position:absolute;
    top:10px; left:50%; transform:translateX(-50%);
    background:rgba(255,255,255,.8); padding:6px 10px; border-radius:999px;
    border:1px solid rgba(0,0,0,.06);
    font-weight:900; letter-spacing:.2px;
  }

  /* Status à direita */
  .status h3{margin:0 0 10px 0; font-size: clamp(16px,2.2vw,20px)}
  .statrow{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px dashed rgba(255,255,255,.4); }
  .badge{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px; font-weight:700; font-size:13px;
    background:rgba(255,255,255,.75);
    border:1px solid rgba(0,0,0,.06);
  }
  .dot{width:10px; height:10px; border-radius:50%; background:#bbb;}
  .on .dot{ background: #10b981; box-shadow:0 0 0 3px rgba(16,185,129,.25); }
  .off .dot{ background:#bbb; }
  .help{
    font-size:12px; opacity:.9; margin-top:8px; line-height:1.4;
  }

  footer{
    opacity:.9; font-size:12px; text-align:center; margin-top:6px;
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 3l3 5h-6l3-5zm-6.5 9a6.5 6.5 0 1013 0h-2a4.5 4.5 0 11-9 0h-2z" fill="#0ea5a8"/>
          <circle cx="12" cy="17.5" r="3.5" fill="#1e88e5"/>
        </svg>
        <h1>Placa Solar (1 W) x Placa 1000 W • Controle USB</h1>
      </div>
      <div class="pill">
        <span id="gpStatusDot" class="dot"></span>
        <span id="gpStatusText">Aguardando controle USB…</span>
        <button class="btn" id="startBtn" style="margin-left:10px">Iniciar leitura</button>
      </div>
    </header>

    <main>
      <!-- ESQUERDA: Informações em tempo real -->
      <section class="card info" aria-live="polite">
        <h2>Informações (tempo real)</h2>
        <div class="metrics">
          <div class="kpi">
            <div class="label">Nível do gráfico</div>
            <div class="value"><span id="kpiPerc">0</span>%</div>
          </div>
          <div class="kpi">
            <div class="label">Mini placa (1 W máx)</div>
            <div class="value"><span id="kpiMini">0,00</span> W</div>
          </div>
          <div class="kpi">
            <div class="label">Placa residencial (1000 W)</div>
            <div class="value"><span id="kpiHouse">0</span> W</div>
          </div>
          <div class="kpi">
            <div class="label">Situação</div>
            <div class="value" id="kpiLabel">Sem energia</div>
          </div>
        </div>
        <div class="loads">
          <strong>O que daria para ligar em casa:</strong>
          <div id="loadsText">Nada — sem energia disponível.</div>
          <div style="font-size:12px; opacity:.85; margin-top:6px">
            <em>Observação:</em> estimativas aproximadas; não considera picos de partida (ex.: geladeira).
          </div>
        </div>
      </section>

      <!-- CENTRO: Gráfico -->
      <section class="card chart">
        <div></div>
        <div class="barwrap" role="img" aria-label="Barra vertical de produção de energia">
          <div class="percentTag"><span id="percentTop">0</span>%</div>
          <div class="ticks">
            <!-- 35% -->
            <div class="tick" style="top: calc(100% - 35% - 10px);">
              <span class="tlabel" style="top:0">35%</span>
            </div>
            <!-- 70% -->
            <div class="tick" style="top: calc(100% - 70% - 10px);">
              <span class="tlabel" style="top:0">70%</span>
            </div>
            <!-- 100% -->
            <div class="tick" style="top: calc(0% + 0px);">
              <span class="tlabel" style="top:0">100%</span>
            </div>
          </div>
          <div id="bar" class="bar"></div>
        </div>
        <div></div>
      </section>

      <!-- DIREITA: Status & Botões -->
      <section class="card status">
        <h3>Status do controle</h3>
        <div class="statrow"><div>Gamepad:</div><div class="badge" id="gpName">—</div></div>
        <div class="statrow"><div>B9</div><div class="badge off" id="b9"><span class="dot"></span>Index 9</div></div>
        <div class="statrow"><div>B10</div><div class="badge off" id="b10"><span class="dot"></span>Index 10</div></div>
        <div class="statrow"><div>B11</div><div class="badge off" id="b11"><span class="dot"></span>Index 11</div></div>
        <div class="help">
          • Conecte o controle via <strong>USB</strong> e pressione um botão para o navegador detectá-lo.<br/>
          • Combinações válidas: <strong>B11</strong> sozinho (35%), <strong>B11+B10</strong> (70%), <strong>B11+B10+B9</strong> (100%).<br/>
          • Nenhum botão pressionado → 0%.
        </div>
      </section>
    </main>

    <footer>
      Feito com Gamepad API (Android/Windows). Fundo amarelo/laranja; detalhes verde/azul; layout responsivo com margem superior e inferior.
    </footer>
  </div>

<script>
(() => {
  const bar = document.getElementById('bar');
  const percentTop = document.getElementById('percentTop');
  const kpiPerc = document.getElementById('kpiPerc');
  const kpiMini = document.getElementById('kpiMini');
  const kpiHouse = document.getElementById('kpiHouse');
  const loadsText = document.getElementById('loadsText');
  const kpiLabel = document.getElementById('kpiLabel');
  const gpStatusText = document.getElementById('gpStatusText');
  const gpStatusDot = document.getElementById('gpStatusDot');
  const gpName = document.getElementById('gpName');
  const startBtn = document.getElementById('startBtn');

  const b9El = document.getElementById('b9');
  const b10El = document.getElementById('b10');
  const b11El = document.getElementById('b11');

  let rafId = null;
  let running = false;

  let targetPerc = 0;
  let lastPerc = -1;

  function fmt(n, d=2){
    return n.toLocaleString('pt-BR', {minimumFractionDigits:d, maximumFractionDigits:d});
  }

  function describeLoads(pHouseW){
    if (pHouseW < 1) return 'Nada — sem energia disponível.';
    if (pHouseW < 400) return '1 TV LED (~100 W), roteador Wi-Fi (~10 W) e 3–5 lâmpadas LED (30–50 W) + ventilador pequeno (~50 W).';
    if (pHouseW < 850) return 'Geladeira (em funcionamento ~150 W, sem considerar pico) + TV LED + roteador + 5–8 lâmpadas + ventilador.';
    return 'Geladeira + TV + roteador + lâmpadas + notebook/PC leve. (Atenção aos picos de partida da geladeira.)';
  }

  function labelFor(perc){
    switch(perc){
      case 0: return 'Sem energia';
      case 35: return 'Baixa produção';
      case 70: return 'Média produção';
      case 100: return 'Produção máxima';
      default: return 'Produção';
    }
  }

  function updateUI(perc){
    // Atualiza barra (anima via CSS transition)
    bar.style.height = perc + '%';
    percentTop.textContent = perc;
    kpiPerc.textContent = perc;

    // Cálculos
    const pMiniW  = (perc/100) * 1;     // até 1 W
    const pHouseW = (perc/100) * 1000;  // até 1000 W

    kpiMini.textContent = fmt(pMiniW, 2);
    kpiHouse.textContent = pHouseW.toLocaleString('pt-BR', {maximumFractionDigits:0});
    loadsText.textContent = describeLoads(pHouseW);
    kpiLabel.textContent = labelFor(perc);
  }

  function setConnected(connected, id='—'){
    gpStatusText.textContent = connected ? 'Controle detectado' : 'Aguardando controle USB…';
    gpStatusDot.style.background = connected ? '#10b981' : '#bbb';
    gpName.textContent = id || '—';
  }

  function pressed(btn){
    return btn && (btn.pressed || btn.value > 0.5);
  }

  function loop(){
    const pads = navigator.getGamepads ? navigator.getGamepads() : [];
    const gp = pads && pads[0];

    if (gp){
      // Mostrar conexão
      setConnected(true, gp.id);

      // Estados dos botões 9/10/11
      const b9  = gp.buttons[9]  ? pressed(gp.buttons[9])  : false;
      const b10 = gp.buttons[10] ? pressed(gp.buttons[10]) : false;
      const b11 = gp.buttons[11] ? pressed(gp.buttons[11]) : false;

      b9El.classList.toggle('on',  b9);   b9El.classList.toggle('off', !b9);
      b10El.classList.toggle('on', b10);  b10El.classList.toggle('off',!b10);
      b11El.classList.toggle('on', b11);  b11El.classList.toggle('off',!b11);

      // Lógica de destino
      let next = 0;
      if (b11 && b10 && b9)      next = 100;
      else if (b11 && b10)       next = 70;
      else if (b11)              next = 35;
      else                       next = 0;

      // Atualiza somente quando muda o alvo
      if (next !== targetPerc){
        targetPerc = next;
      }
    } else {
      setConnected(false);
    }

    // Se alvo mudou desde a última renderização, atualiza UI (transition cuida da suavidade)
    if (targetPerc !== lastPerc){
      updateUI(targetPerc);
      lastPerc = targetPerc;
    }

    rafId = requestAnimationFrame(loop);
  }

  // Botão iniciar (ajuda em Android exigindo gesto do usuário)
  startBtn.addEventListener('click', () => {
    if (!running){
      running = true;
      if (rafId) cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(loop);
    }
  });

  window.addEventListener('gamepadconnected', (e) => {
    setConnected(true, e.gamepad.id);
  });
  window.addEventListener('gamepaddisconnected', () => {
    setConnected(false);
  });

  // Inicial: render 0%
  updateUI(0);
})();
</script>
</body>
</html>
  .value-badge{
    align-self:flex-start;
    font-size:48px; font-weight:700; letter-spacing:-0.02em; line-height:1;
    display:flex; gap:10px; align-items:baseline;
  }
  .unit{ font-size:14px; opacity:0.8 }
  .hint{ font-size:12px; opacity:0.75 }

  /* Painel de Controles */
  .controls{ display:grid; gap:16px }
  .row{ display:flex; gap:14px; align-items:center; flex-wrap:wrap }
  .chip{
    padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,0.25);
    background: rgba(255,255,255,0.06); font-size:12px
  }
  .kbd{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    padding:4px 8px; border-radius:8px; border:1px solid rgba(255,255,255,0.25);
    background: rgba(255,255,255,0.08); font-size:12px
  }
  .slider{ width:200px; max-width:60vw }
  .btn{
    appearance:none; border:0; cursor:pointer; padding:12px 16px; border-radius:12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.09));
    border:1px solid rgba(255,255,255,0.35); color:#fff; font-weight:600; box-shadow: var(--shadow);
    transition: transform .12s ease, background .2s ease;
  }
  .btn:active{ transform: translateY(1px) scale(.99) }
  .btn-alt{ background: linear-gradient(180deg, rgba(125,211,252,0.25), rgba(125,211,252,0.10)) }

  /* Pequeno monitor do gamepad */
  .gp-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:12px }
  .meter{
    height:8px; background:rgba(255,255,255,0.12); border-radius:999px; overflow:hidden
  }
  .meter > div{ height:100%; width:50%; transition: width 80ms linear;
    background: linear-gradient(90deg, #34d399, #60a5fa) }

  footer{ text-align:center; opacity:0.75; font-size:12px }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Painel da Barra -->
    <section class="card bar-panel">
      <div class="bar-frame">
        <div class="bar-track" aria-label="Indicador de nível">
          <div class="bar-fill" id="barFill"></div>
          <div class="bar-glow"></div>
          <div class="bar-scale" aria-hidden="true">
            <span>100%</span><span>80%</span><span>60%</span><span>40%</span><span>20%</span><span>0%</span>
          </div>
        </div>
      </div>
      <div style="display:flex; flex-direction:column; gap:14px; justify-content:center">
        <div class="value-badge">
          <span id="valueText">50</span><span class="unit">%</span>
        </div>
        <div class="hint">Use o analógico <strong>esquerdo (eixo Y)</strong> ↑/↓ para ajustar. Suavização automática.</div>
        <div class="row">
          <button class="btn" id="btnUp" aria-label="Subir">↑ Subir</button>
          <button class="btn" id="btnDown" aria-label="Descer">↓ Descer</button>
          <button class="btn btn-alt" id="btnCenter" aria-label="Centralizar">• Centralizar (50%)</button>
        </div>
      </div>
    </section>

    <!-- Painel de Controles / Status -->
    <aside class="card controls">
      <div class="row" style="justify-content:space-between">
        <div class="chip" id="status">Aguardando gamepad… pressione qualquer botão.</div>
        <div class="chip">Compatível: Chrome/Android</div>
      </div>

      <div class="row">
        <label for="sens">Sensibilidade</label>
        <input id="sens" class="slider" type="range" min="0.2" max="3" step="0.1" value="1.2" />
        <span class="kbd" id="sensVal">1.2×</span>
      </div>

      <div class="row">
        <label for="smooth">Suavização</label>
        <input id="smooth" class="slider" type="range" min="0.85" max="0.995" step="0.005" value="0.96" />
        <span class="kbd" id="smoothVal">0.96</span>
      </div>

      <div class="row">
        <div class="kbd">Analógico Y (filtrado): <span id="axisYDisp">0.00</span></div>
        <div class="kbd">Botões ↑/↓: <span id="btnsDisp">0 / 0</span></div>
      </div>

      <div class="gp-grid">
        <div>Entrada ↑/↓</div><div class="meter"><div id="meter"></div></div>
        <div>Gamepad</div><div id="gpName">—</div>
      </div>

      <footer>
        Dica: Alguns controles só aparecem após “acordar” o gamepad com um clique de botão.<br/>
        Se seu controle não for detectado, ative Bluetooth/OTG e teste em <code>chrome://gamepad-internals</code>.
      </footer>
    </aside>
  </div>

<script>
(() => {
  // Estado principal
  let level = 50;           // 0..100 (nível "real")
  let displayLevel = 50;    // nível exibido (ease)
  let axisYFiltered = 0;    // eixo Y com filtro
  let lastTs = performance.now();
  let connectedIndex = null;

  // Configs ajustáveis
  let sensitivity = 1.2;    // ganho base
  let smoothing = 0.96;     // filtro exponencial para entrada e exibição

  // UI refs
  const barFill   = document.getElementById('barFill');
  const valueText = document.getElementById('valueText');
  const statusEl  = document.getElementById('status');
  const sensEl    = document.getElementById('sens');
  const sensVal   = document.getElementById('sensVal');
  const smoothEl  = document.getElementById('smooth');
  const smoothVal = document.getElementById('smoothVal');
  const axisYDisp = document.getElementById('axisYDisp');
  const btnsDisp  = document.getElementById('btnsDisp');
  const gpName    = document.getElementById('gpName');
  const meterBar  = document.getElementById('meter');
  const btnUp     = document.getElementById('btnUp');
  const btnDown   = document.getElementById('btnDown');
  const btnCenter = document.getElementById('btnCenter');

  // Suporte
  const supported = !!navigator.getGamepads;
  if(!supported){
    statusEl.textContent = 'Gamepad API não suportada neste navegador.';
  }

  // Conexão/desconexão
  window.addEventListener('gamepadconnected', (e) => {
    connectedIndex = e.gamepad.index;
    gpName.textContent = e.gamepad.id;
    statusEl.textContent = 'Gamepad conectado ✅';
  });

  window.addEventListener('gamepaddisconnected', () => {
    connectedIndex = null;
    gpName.textContent = '—';
    statusEl.textContent = 'Gamepad desconectado. Reconnecte e pressione um botão.';
  });

  // Interações de toque como alternativa
  let touchInterval = null;
  const startTouchMove = (dir) => {
    stopTouchMove();
    touchInterval = setInterval(() => {
      // dir: +1 para subir, -1 para descer
      level = clamp(level + dir * 0.8 * sensitivity, 0, 100);
    }, 16);
  };
  const stopTouchMove = () => { if(touchInterval){ clearInterval(touchInterval); touchInterval = null; } };

  btnUp.addEventListener('touchstart',   () => startTouchMove(+1), {passive:true});
  btnUp.addEventListener('touchend',     stopTouchMove);
  btnDown.addEventListener('touchstart', () => startTouchMove(-1), {passive:true});
  btnDown.addEventListener('touchend',   stopTouchMove);

  // Click/tap normal
  btnUp.addEventListener('mousedown',   () => startTouchMove(+1));
  btnDown.addEventListener('mousedown', () => startTouchMove(-1));
  ['mouseup','mouseleave','blur'].forEach(ev => {
    btnUp.addEventListener(ev, stopTouchMove);
    btnDown.addEventListener(ev, stopTouchMove);
  });
  btnCenter.addEventListener('click', () => { level = 50; });

  // Sliders
  sensEl.addEventListener('input', (e) => {
    sensitivity = parseFloat(e.target.value);
    sensVal.textContent = sensitivity.toFixed(1) + '×';
  });
  smoothEl.addEventListener('input', (e) => {
    smoothing = parseFloat(e.target.value);
    smoothVal.textContent = smoothing.toFixed(3);
  });

  // Loop principal
  function tick(ts){
    const dt = Math.max(0, Math.min(1/20, (ts - lastTs)/1000)); // limita dt a 50ms
    lastTs = ts;

    // Leitura do gamepad
    const gp = getActiveGamepad();
    let axisY = 0, dpadUp = 0, dpadDown = 0;

    if(gp){
      if(connectedIndex === null){ connectedIndex = gp.index; }
      // Eixo Y do analógico esquerdo é geralmente axes[1]:
      axisY = gp.axes && gp.axes.length > 1 ? gp.axes[1] : 0;
      // Botões D-pad ↑ (12) e ↓ (13) na maioria dos mapeamentos
      dpadUp = getButtonValue(gp, 12);
      dpadDown = getButtonValue(gp, 13);
      gpName.textContent = gp.id;
      statusEl.textContent = 'Gamepad conectado ✅';
    }

    // Deadzone + filtro exponencial
    const deadzone = 0.12;
    const rawY = Math.abs(axisY) < deadzone ? 0 : axisY;
    axisYFiltered = expSmooth(axisYFiltered, rawY, smoothing);

    // Controle: no eixo Y dos gamepads, -1 = para cima, +1 = para baixo
    // Movemos a barra em porcentagem/segundo; ganho proporcional à sensibilidade
    const speed = 60 * sensitivity; // % por segundo com entrada máxima
    const dFromAxis = -axisYFiltered * speed * dt;

    // D-pad como incremento sob demanda (bem suave)
    const dpadDelta = (dpadUp ? +1 : 0) + (dpadDown ? -1 : 0);
    const dFromDpad = dpadDelta * 30 * dt; // 30%/s

    level = clamp(level + dFromAxis + dFromDpad, 0, 100);

    // Exibição suavizada (ease-out exponencial)
    displayLevel = expSmooth(displayLevel, level, 0.90);

    // UI
    barFill.style.height = displayLevel.toFixed(2) + '%';
    valueText.textContent = Math.round(displayLevel);
    axisYDisp.textContent = axisYFiltered.toFixed(2);
    btnsDisp.textContent = (dpadUp?1:0) + ' / ' + (dpadDown?1:0);
    meterBar.style.width = ( (Math.max(-1, Math.min(1, -axisYFiltered)) + 1) * 50 ).toFixed(1) + '%';

    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

  // Utilitários
  function getActiveGamepad(){
    const pads = navigator.getGamepads ? navigator.getGamepads() : [];
    if(!pads) return null;
    // Se já temos um índice conectado, priorize
    if(connectedIndex !== null && pads[connectedIndex] && pads[connectedIndex].connected) return pads[connectedIndex];
    // Caso contrário, pegue o primeiro conectado
    for(const p of pads){ if(p && p.connected) return p; }
    return null;
  }
  function getButtonValue(gp, idx){
    if(!gp || !gp.buttons || !gp.buttons[idx]) return 0;
    const b = gp.buttons[idx];
    return b.value !== undefined ? b.value : (b.pressed ? 1 : 0);
  }
  function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }
  // Suavização exponencial: out = alpha*new + (1-alpha)*old
  function expSmooth(oldVal, newVal, alpha){
    // Se alpha ~ 1, resposta rápida; se ~0.9, bem suave.
    return oldVal + (newVal - oldVal) * alpha;
  }
})();
</script>
</body>
</html>


